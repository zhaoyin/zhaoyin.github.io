
<main id="main" class="main">
    <div class="main-inner">
        <div class="content-wrap">
            <div id="content" class="content">


                <div id="posts" class="posts-expand">








                    <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
                        <link itemprop="mainEntityOfPage" href="http://xcoder.me/2017-05/tools/转换HQL为原生SQL解决Cross Join问题/">

                        <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="小英雄雨来">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

                        <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="架构演进之旅">
    </span>


                        <header class="post-header">



                            <h2 class="post-title" itemprop="name headline">转换HQL为原生SQL解决Cross Join问题</h2>


                            <div class="post-meta">
          <span class="post-time">





              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>

                <span class="post-meta-item-text">更新于</span>

              <time title="更新于" itemprop="dateModified" datetime="2017-05-30T05:16:34+00:00">
                2017-05-30
              </time>

          </span>


                                <span class="post-category" >

              <span class="post-meta-divider">|</span>

              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>

                <span class="post-meta-item-text">分类于</span>


                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/tools/" itemprop="url" rel="index">
                    <span itemprop="name">tools</span>
                  </a>
                </span>




            </span>








                                <span id="/2017-05/tools/转换HQL为原生SQL解决Cross Join问题/" class="leancloud_visitors" data-flag-title="转换HQL为原生SQL解决Cross Join问题">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>

                 <span class="post-meta-item-text">阅读次数 </span>

                 <span class="leancloud-visitors-count"></span>
             </span>








                            </div>
                        </header>


                        <div class="post-body" itemprop="articleBody">





                            <a class="post-gallery" target="_blank" itemprop="contents" href="https://s.click.taobao.com/t?e=m%3D2%26s%3DS2FPo9pod%2FMcQipKwQzePCperVdZeJviEViQ0P1Vf2kguMN8XjClAoggAmZh6Xz4dTUCp7J6xLhlPjx8CqYfPWjTbzraVxy7YzvZkCrmclL9U03wBYLV9%2Bdn1BbglxZYxUhy8exlzcpAFEHVckI7b93srg%2FL%2FeD3keUEnoKELDlWYetMiZZgV%2BSx6OrKqagyklzFeKMz7Cd4Qek9OyREeQ%2BdciYQJaT7LNmFwzcjFAU%3D" title="阿里云推广">
                                <img src="http://oqcey66z7.bkt.clouddn.com/public/images/aliyun-ECS-AD/700-90.jpg" height="90" width="700" alt="阿里云推广" />
                            </a>
                            <br/>
                            [本文(转换HQL为原生SQL解决Cross Join问题)原始地址]<a href="http://xcoder.me/2017-05/tools/转换HQL为原生SQL解决Cross Join问题/" title="转换HQL为原生SQL解决Cross Join问题">http://xcoder.me/2017-05/tools/转换HQL为原生SQL解决Cross Join问题/</a>
                            <p><a href="https://github.com/hibernate/hibernate-orm/blob/0a2a5c622e3eb30724e80bc8661c0ac55ebfb2be/hibernate-core/src/test/java/org/hibernate/test/locale/LocaleTest.java#L43" target="_blank" rel="external">Hibernate 测试用例</a></p>
                            <p>Hibernate将HQL转换为原生sql的测试用例。</p>
                            <a id="more"></a>
                            <p>为了能够让Gson直接解析实体类时不会出现栈溢出和死循环，我们去掉了实体类通过@OneToOne,@OneToMany,@ManyToMany注解的方式来描述元数据。而是通过元数据描述的形式来定义</p>
                            <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    String srcType = &quot;SaleReturn&quot;;</div><div class="line">    List&lt;Relation&gt; relations = new ArrayList&lt;&gt;();</div><div class="line">    relations.add(new Relation(srcType, &quot;iLogisticWayId&quot;, &quot;models.corp.CorprationLogistics&quot;, &quot;id&quot;));</div><div class="line">    relations.add(new Relation(srcType, &quot;iSaleReturnMemoId&quot;, &quot;models.voucher.VoucherMemo&quot;, &quot;id&quot;));</div><div class="line">    metaMap.put(srcType, relations);</div><div class="line">&#125;</div><div class="line">&#123;</div><div class="line">    String srcType = &quot;SaleReturnDetail&quot;;</div><div class="line">    List&lt;Relation&gt; relations = new ArrayList&lt;&gt;();</div><div class="line">    relations.add(new Relation(srcType, &quot;cDeliveryNo&quot;, &quot;models.voucher.SaleReturnPrice&quot;, &quot;cVoucherNo&quot;));</div><div class="line">    metaMap.put(srcType, relations);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
                            <p>为了最终能够更通用的处理业务关系，我们选择通过元数据构造查询方案的方式来处理复杂业务数据查询。前端通过构造强大可自由定制的元数据查询方案来统一处理集合数据查询。</p>
                            <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">	&quot;fields&quot;:[</div><div class="line">		&#123;&quot;name&quot;:&quot;(num?0)*(price?(goods.price?5))&quot;,&quot;alias&quot;:&quot;totalmoney&quot;&#125;,</div><div class="line">		&#123;&quot;name&quot;:&quot;belongOrder&quot;&#125;,</div><div class="line">		&#123;&quot;name&quot;:&quot;belongOrder.code&quot;&#125;,</div><div class="line">		&#123;&quot;name&quot;:&quot;num&quot;,&quot;aggr&quot;:&quot;sum&quot;&#125;,</div><div class="line">		&#123;&quot;name&quot;:&quot;price&quot;,&quot;aggr&quot;:&quot;avg&quot;&#125;,</div><div class="line">		&#123;&quot;name&quot;:&quot;1&quot;,&quot;alias&quot;:&quot;totalcount&quot;,&quot;aggr&quot;:&quot;count&quot;&#125;</div><div class="line">	],</div><div class="line">	&quot;conditions&quot;:[</div><div class="line">		&#123;&quot;op&quot;:&quot;or&quot;,&quot;items&quot;:[</div><div class="line">				&#123;&quot;op&quot;:&quot;and&quot;,&quot;items&quot;:[</div><div class="line">						&#123;&quot;name&quot;:&quot;(num?0)*(price?(goods.price?1))/100&quot;,&quot;v1&quot;:&quot;50&quot;,&quot;op&quot;:&quot;gt&quot;&#125;,</div><div class="line">						&#123;&quot;name&quot;:&quot;goods.name&quot;,&quot;v1&quot;:&quot;电器&quot;,&quot;op&quot;:&quot;leftlike&quot;&#125;,</div><div class="line">						&#123;&quot;name&quot;:&quot;price&quot;,&quot;v1&quot;:&quot;5&quot;,&quot;v2&quot;:&quot;10&quot;,&quot;op&quot;:&quot;between&quot;&#125;</div><div class="line">					]</div><div class="line">				&#125;,</div><div class="line">				&#123;&quot;op&quot;:&quot;and&quot;,&quot;items&quot;:[</div><div class="line">						&#123;&quot;name&quot;:&quot;belongOrder.status&quot;,&quot;v1&quot;:&quot;1,2&quot;,&quot;op&quot;:&quot;in&quot;&#125;,</div><div class="line">						&#123;&quot;name&quot;:&quot;belongOrder.belongUser&quot;,&quot;op&quot;:&quot;is_not_null&quot;&#125;</div><div class="line">					]</div><div class="line">				&#125;</div><div class="line">			]</div><div class="line">		&#125;</div><div class="line">	],</div><div class="line">	&quot;groups&quot;:[</div><div class="line">		&#123;&quot;name&quot;:&quot;belongOrder&quot;&#125;,</div><div class="line">		&#123;&quot;name&quot;:&quot;belongOrder.code&quot;&#125;</div><div class="line">	],</div><div class="line">	&quot;orders&quot;:[</div><div class="line">		&#123;&quot;name&quot;:&quot;belongOrder.code&quot;,&quot;order&quot;:&quot;desc&quot;&#125;</div><div class="line">	],</div><div class="line">	&quot;pager&quot;:&#123;&quot;pageIndex&quot;:1,&quot;pageSize&quot;:10&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
                            <p>这样的数据经过后台处理后，为了能结合实体对象处理，最终会生成hql，但是因为没有通过Hibernate的方式定义实体对象的数据关系，最终生成的hql在生成最终的原生sql时会变成通过cross join的方式处理数据关联。但是其实因为这些数据只是没有通过hql的方式定义，他们之间的关系完全是left join或者inner join的。</p>
                            <p>所以我们的方案是通过查询方案生成hql后，通过类似Hibernate测试用例中所用的方式来将hql处理成原生sql后再将原生sql中的cross join替换成left join。最终再以原生sql的方式来处理。当然这是基于我们数据处理的方式和关系决定的。<br>这样既不失高效，又能用上hql的面向对象。</p>
                            <p><strong>但是据说Hibernate在5.1之后已经解决了cross join的问题</strong><br><a href="https://hibernate.atlassian.net/projects/HHH/issues/HHH-16?filter=allissues&amp;orderby=votes+DESC%2C+priority+DESC%2C+updated+DESC" target="_blank" rel="external">Hibernate ORM</a></p>
                            <p>回头可以试一下。</p>

                            <a class="post-gallery" target="_blank" itemprop="contents" href="https://s.click.taobao.com/t?e=m%3D2%26s%3DGxUK4RxRAUwcQipKwQzePCperVdZeJviK7Vc7tFgwiFRAdhuF14FMaoDsluWCMrtJ1gyddu7kN%2FjA8%2F%2BZJDLfQ4Zu0ikTBVI5H6lqT7H0fKnLcgY8qPbG6UuZxIcp9pfUIgVEmFmgnaR4ypTBJBwtB6l0bxfYrBpJPwiig1bxLMAV4Err%2B0r%2ByrbHgqSJ08vcSpj5qSCmbA%3D" title="2017天猫618">
                                <img src="https://img.alicdn.com/tfs/TB1_phpRpXXXXaTXVXXXXXXXXXX-440-180.jpg" height="180" width="440" alt="2017天猫618" />
                            </a>

                        </div>

                        <div>




                        </div>

                        <div>



                            <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
                                <div>enjoy?donate!</div>
                                <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
                                    <span>赏</span>
                                </button>
                                <div id="QR" style="display: none;">

                                    <div id="wechat" style="display: inline-block">
                                        <img id="wechat_qr" src="http://oqcey66z7.bkt.clouddn.com/public/images/wechat.png" alt="小英雄雨来 WeChat Pay"/>
                                        <p>微信打赏</p>
                                    </div>


                                    <div id="alipay" style="display: inline-block">
                                        <img id="alipay_qr" src="http://oqcey66z7.bkt.clouddn.com/public/images/alipay.png" alt="小英雄雨来 Alipay"/>
                                        <p>支付宝打赏</p>
                                    </div>

                                </div>
                            </div>



                        </div>

                        <div>


                            <ul class="post-copyright">
                                <li class="post-copyright-author">
                                    <strong>本文作者：</strong>
                                    小英雄雨来
                                </li>
                                <li class="post-copyright-link">
                                    <strong>本文链接：</strong>
                                    <a href="http://xcoder.me/2017-05/tools/转换HQL为原生SQL解决Cross Join问题/" title="转换HQL为原生SQL解决Cross Join问题">http://xcoder.me/2017-05/tools/转换HQL为原生SQL解决Cross Join问题/</a>
                                </li>
                                <li class="post-copyright-license">
                                    <strong>版权声明： </strong>
                                    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-nd/4.0/" rel="external nofollow" target="_blank">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a> 许可协议。转载请注明出处！
                                </li>
                            </ul>



                        </div>

                        <footer class="post-footer">

                            <div class="post-tags">

                                <a href="/tags/Hibernate/" rel="tag"># Hibernate</a>

                                <a href="/tags/HQL/" rel="tag"># HQL</a>

                                <a href="/tags/Cross-Join/" rel="tag"># Cross Join</a>

                            </div>







                            <div class="post-nav">
                                <div class="post-nav-next post-nav-item">

                                    <a href="/2017-05/life/2B和2C站点的区别/" rel="next" title="2B和2C站点的区别">
                                        <i class="fa fa-chevron-left"></i> 2B和2C站点的区别
                                    </a>

                                </div>

                                <span class="post-nav-divider"></span>

                                <div class="post-nav-prev post-nav-item">

                                    <a href="/2017-05/tools/IntelliJ IDEA使用总结/" rel="prev" title="IntelliJ IDEA使用总结">
                                        IntelliJ IDEA使用总结 <i class="fa fa-chevron-right"></i>
                                    </a>

                                </div>
                            </div>




                        </footer>
                    </article>



                    <div class="post-spread">

                        <!-- JiaThis Button BEGIN -->
                        <div class="jiathis_style">
                            <a class="jiathis_button_tsina"></a>
                            <a class="jiathis_button_tqq"></a>
                            <a class="jiathis_button_weixin"></a>
                            <a class="jiathis_button_cqq"></a>
                            <a class="jiathis_button_douban"></a>
                            <a class="jiathis_button_renren"></a>
                            <a class="jiathis_button_qzone"></a>
                            <a class="jiathis_button_kaixin001"></a>
                            <a class="jiathis_button_copy"></a>
                            <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
                            <a class="jiathis_counter_style"></a>
                        </div>
                        <script type="text/javascript" >
                            var jiathis_config={
                                hideMore:false
                            }
                        </script>
                        <script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
                        <!-- JiaThis Button END -->


                    </div>
                </div>


            </div>





            <div class="comments" id="comments">

            </div>


        </div>



        <div class="sidebar-toggle">
            <div class="sidebar-toggle-line-wrap">
                <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
                <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
                <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
            </div>
        </div>

        <aside id="sidebar" class="sidebar">
            <div class="sidebar-inner">





                <section class="site-overview sidebar-panel sidebar-panel-active">
                    <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
                        <img class="site-author-image" itemprop="image"
                             src="/images/avatar.gif"
                             alt="小英雄雨来" />
                        <p class="site-author-name" itemprop="name">小英雄雨来</p>

                        <p class="site-description motion-element" itemprop="description"></p>

                    </div>
                    <nav class="site-state motion-element">


                        <div class="site-state-item site-state-posts">
                            <a href="/archives">
                                <span class="site-state-item-count">16</span>
                                <span class="site-state-item-name">日志</span>
                            </a>
                        </div>





                        <div class="site-state-item site-state-categories">
                            <a href="/categories/index.html">
                                <span class="site-state-item-count">8</span>
                                <span class="site-state-item-name">分类</span>
                            </a>
                        </div>





                        <div class="site-state-item site-state-tags">
                            <a href="/tags/index.html">
                                <span class="site-state-item-count">39</span>
                                <span class="site-state-item-name">标签</span>
                            </a>
                        </div>


                    </nav>



                    <div class="links-of-author motion-element">

                    </div>






                    <div class="links-of-blogroll motion-element links-of-blogroll-inline">
                        <div class="links-of-blogroll-title">
                            <i class="fa  fa-fw fa-globe"></i>
                            收藏
                        </div>
                        <ul class="links-of-blogroll-list">

                            <li class="links-of-blogroll-item">
                                <a href="http://news.dbanotes.net/" title="dbanotes" target="_blank">dbanotes</a>
                            </li>

                            <li class="links-of-blogroll-item">
                                <a href="http://hedengcheng.com/" title="数据库" target="_blank">数据库</a>
                            </li>

                            <li class="links-of-blogroll-item">
                                <a href="http://www.ruanyifeng.com/blog/" title="ruanyifeng" target="_blank">ruanyifeng</a>
                            </li>

                            <li class="links-of-blogroll-item">
                                <a href="https://readhub.me/" title="readhub" target="_blank">readhub</a>
                            </li>

                            <li class="links-of-blogroll-item">
                                <a href="https://www.thoughtworks.com/cn/radar" title="技术雷达" target="_blank">技术雷达</a>
                            </li>

                        </ul>
                    </div>





                </section>





            </div>
        </aside>



    </div>
</main>
